map vi {
  # default insert/edit mode
  mode 0 edit {
    EndOfFile { EndOfFile; }
    SigInt { SigInt; }
    SigQuit { SigQuit; }
    SigSusp { SigSusp; }
    Any { Glyph; }
    Erase { Left[Del]; }
    WErase { RevWord[Del|Unix]; }
    Kill { Home[Del]; }
    LNext { Glyph(, '^'); Left[Mv]; Push(1); }
    Enter { Enter; }
    Up { Up[Mv]; }
    Down { Down[Mv]; }
    Left { Left[Mv]; }
    Right { Right[Mv]; }
    Home { Home[Mv]; }
    End { End[Mv]; }
    PgUp { Prev; }
    PgDn { Next; }
    Insert { InsToggle; }
    Delete { Right[Del]; }
    Up[Shift] { Up[Mv|Vis]; Push(2); }
    Down[Shift] { Down[Mv|Vis]; Push(2); }
    Left[Shift] { Left[Mv|Vis]; Push(2); }
    Right[Shift] { Right[Mv|Vis]; Push(2); }
    Home[Shift] { Home[Mv|Vis]; Push(2); }
    End[Shift] { End[Mv|Vis]; Push(2); }
    Left[Ctrl] { RevWord[Mv]; }
    Right[Ctrl] { FwdWord[Mv]; }
    Left[Shift|Ctrl] { RevWord[Mv|Vis]; Push(2); }
    Right[Shift|Ctrl] { FwdWordEnd[Mv|Vis|Past]; Push(2); }
    Left[Alt] { RevWord[Mv|Unix]; }
    Right[Alt] { FwdWord[Mv|Unix]; }
    Left[Shift|Alt] { RevWord[Mv|Vis|Unix]; Push(2); }
    Right[Shift|Alt] { FwdWordEnd[Mv|Vis|Unix|Past]; Push(2); }
    ^D { ListComplete; }
    ^I { Complete; }
    ^[ { Mode(3); }
  }
  # literal next
  mode 1 edit {
    Any { OverGlyph; Pop; }
    AnyFn { Pop[Redir]; }
  }
  # highlight "visual" mode
  mode 2 edit {
    Any { ClrVis[Del]; Pop[Redir]; }
    AnyFn { ClrVis; Pop[Redir]; }
    Erase { Nop[Redir](, Delete); }
    Delete { ClrVis[Del]; Pop; }
    Up[Shift] { Up[Mv|Vis]; }
    Down[Shift] { Down[Mv|Vis]; }
    Left[Shift] { Left[Mv|Vis]; }
    Right[Shift] { Right[Mv|Vis]; }
    Home[Shift] { Home[Mv|Vis]; }
    End[Shift] { End[Mv|Vis]; }
    Left[Shift|Ctrl] { RevWord[Mv|Vis]; }
    Right[Shift|Ctrl] { FwdWordEnd[Mv|Vis|Past]; }
    Left[Shift|Alt] { RevWord[Mv|Vis|Unix]; }
    Right[Shift|Alt] { FwdWordEnd[Mv|Vis|Unix|Past]; }
    'd' { ClrVis[Del|Copy]; Pop; }
    'x' { Nop[Redir](, 'd'); }
    'c' { Nop[Redir](, 'd'); }
    's' { Nop[Redir](, 'd'); }
    'y' { ClrVis[Copy]; Pop; }
    'p' { ClrVis[Del]; Paste; Pop; }
    'P' { Nop[Redir](, 'p'); }
    '~' { CapVis; }
    'U' { UpperVis; }
    'u' { LowerVis; }
  }
  # command mode
  mode 3 {
    EndOfFile { Mode[Redir](0); }
    SigInt { Mode[Redir](0); }
    SigQuit { Mode[Redir](0); }
    SigSusp { Mode[Redir](0); }
    Enter { Mode(0); Enter; }
    Up { Up[Mv]; }
    Down { Down[Mv]; }
    Left { Left[Mv]; }
    Right { Right[Mv]; }
    Home { Home[Mv]; }
    End { End[Mv]; }
    PgUp { Prev; }
    PgDn { Next; }
    Insert { InsToggle; }
    Delete { Right[Del]; }
    Up[Shift] { Up[Mv|Vis]; Push(2); }
    Down[Shift] { Down[Mv|Vis]; Push(2); }
    Left[Shift] { Left[Mv|Vis]; Push(2); }
    Right[Shift] { Right[Mv|Vis]; Push(2); }
    Home[Shift] { Home[Mv|Vis]; Push(2); }
    End[Shift] { End[Mv|Vis]; Push(2); }
    Left[Ctrl] { RevWord[Mv]; }
    Right[Ctrl] { FwdWord[Mv]; }
    Left[Shift|Ctrl] { RevWord[Mv|Vis]; Push(2); }
    Right[Shift|Ctrl] { FwdWordEnd[Mv|Vis|Past]; Push(2); }
    Left[Alt] { RevWord[Mv|Unix]; }
    Right[Alt] { FwdWord[Mv|Unix]; }
    Left[Shift|Alt] { RevWord[Mv|Vis|Unix]; Push(2); }
    Right[Shift|Alt] { FwdWordEnd[Mv|Vis|Unix|Past]; Push(2); }
    '0' { DigitArg; }
    '1' { DigitArg; }
    '2' { DigitArg; }
    '3' { DigitArg; }
    '4' { DigitArg; }
    '5' { DigitArg; }
    '6' { DigitArg; }
    '7' { DigitArg; }
    '8' { DigitArg; }
    '9' { DigitArg; }
    'w' { FwdWord[Mv]; }
    'W' { FwdWord[Mv|Unix]; }
    'e' { FwdWordEnd[Mv]; }
    'E' { FwdWordEnd[Mv|Unix]; }
    'r' { Mode(4); }
    'R' { Mode(0); Over; }
    'u' { Undo; }
    ^R { Redo; }
    'i' { Mode(0); Insert; }
    'I' { Mode(0); Insert; Home[Mv]; }
    'o' { Mode(0); End[Mv]; Home[Del]; }
    'O' { Nop[Redir](, 'o'); }
    'p' { Right[Mv]; Paste; }
    'P' { Paste; }
    'a' { Mode(0); Right[Mv]; }
    'A' { Mode(0); End[Mv]; }
    's' { Mode(0); Right[Del]; }
    'S' { Nop[Redir](, 'o'); }
    'd' { Mode(5); }
    'D' { End[Del]; }
    'g' { Mode(6); }
    'h' { Left[Mv]; }
    'j' { Down[Mv]; }
    'k' { Up[Mv]; }
    'l' { Right[Mv]; }
    'x' { Right[Del]; }
    'c' { Mode(8); }
    'C' { End[Del]; Mode(0); }
    'b' { RevWord[Mv]; }
    'B' { RevWord[Mv|Unix]; }
    'n' { FwdSearch; }
    'N' { RevSearch; }
    '/' { PromptSrch(8); }
    '?' { PromptSrch(9); }
    '^' { Home[Mv]; }
    '$' { End[Mv]; }
  }
  # 'r' single-character replace mode
  mode 4 edit {
    EndOfFile { Mode[Redir](0); }
    SigInt { Mode[Redir](0); }
    SigQuit { Mode[Redir](0); }
    SigSusp { Mode[Redir](0); }
    Any { OverGlyph; Mode(3); }
    AnyFn { Mode[Redir](3); }
  }
  # 'd' delete mode
  mode 5 {
    EndOfFile { Mode[Redir](0); }
    SigInt { Mode[Redir](0); }
    SigQuit { Mode[Redir](0); }
    SigSusp { Mode[Redir](0); }
    Up { Up[Del]; Mode(3); }
    Down { Down[Del]; Mode(3); }
    Left { Left[Del]; Mode(3); }
    Right { Right[Del]; Mode(3); }
    Home { Home[Del]; Mode(3); }
    End { End[Del]; Mode(3); }
    Delete { Right[Del]; Mode(3); }
    Up[Shift] { Up[Del]; Mode(3); }
    Down[Shift] { Down[Del]; Mode(3); }
    Left[Shift] { Left[Del]; Mode(3); }
    Right[Shift] { Right[Del]; Mode(3); }
    Home[Shift] { Home[Del]; Mode(3); }
    End[Shift] { End[Del]; Mode(3); }
    Left[Ctrl] { RevWord[Del]; Mode(3); }
    Right[Ctrl] { FwdWord[Del]; Mode(3); }
    Left[Shift|Ctrl] { RevWord[Del]; Mode(3); }
    Right[Shift|Ctrl] { FwdWordEnd[Del|Past]; Mode(3); }
    Left[Alt] { RevWord[Del|Unix]; Mode(3); }
    Right[Alt] { FwdWord[Del|Unix]; Mode(3); }
    Left[Shift|Alt] { RevWord[Del|Unix]; Mode(3); }
    Right[Shift|Alt] { FwdWordEnd[Del|Unix|Past]; Mode(3); }
    'w' { FwdWord[Del]; Mode(3); }
    'W' { FwdWord[Del|Unix]; Mode(3); }
    'e' { FwdWordEnd[Del]; Mode(3); }
    'E' { FwdWordEnd[Del|Unix]; Mode(3); }
    'g' { Mode(7); Mode(3); }
    'h' { Left[Del]; Mode(3); }
    'j' { Down[Del]; Mode(3); }
    'k' { Up[Del]; Mode(3); }
    'l' { Right[Del]; Mode(3); }
    'x' { Right[Del]; Mode(3); }
    'b' { RevWord[Del]; Mode(3); }
    'B' { RevWord[Del|Unix]; Mode(3); }
    '^' { Home[Del]; Mode(3); }
    '$' { End[Del]; Mode(3); }
    Any { Mode(3); }
    AnyFn { Mode(3); }
  }
  # 'g' go mode
  mode 6 {
    EndOfFile { Mode[Redir](0); }
    SigInt { Mode[Redir](0); }
    SigQuit { Mode[Redir](0); }
    SigSusp { Mode[Redir](0); }
    'e' { Mode(3); RevWordEnd[Mv]; }
    'E' { Mode(3); RevWordEnd[Mv|Unix]; }
    Any { Mode(3); }
    AnyFn { Mode[Redir](3); }
  }
  # 'd' 'g' delete-go mode
  mode 7 {
    EndOfFile { Mode[Redir](0); }
    SigInt { Mode[Redir](0); }
    SigQuit { Mode[Redir](0); }
    SigSusp { Mode[Redir](0); }
    'e' { Mode(3); RevWordEnd[Del]; }
    'E' { Mode(3); RevWordEnd[Del|Unix]; }
    Any { Mode(3); }
    AnyFn { Mode(3); }
  }
  # 'c' change mode
  mode 8 {
    EndOfFile { Mode[Redir](0); }
    SigInt { Mode[Redir](0); }
    SigQuit { Mode[Redir](0); }
    SigSusp { Mode[Redir](0); }
    Up { Up[Del]; Mode(0); }
    Down { Down[Del]; Mode(0); }
    Left { Left[Del]; Mode(0); }
    Right { Right[Del]; Mode(0); }
    Home { Home[Del]; Mode(0); }
    End { End[Del]; Mode(0); }
    Delete { Right[Del]; Mode(0); }
    Up[Shift] { Up[Del]; Mode(0); }
    Down[Shift] { Down[Del]; Mode(0); }
    Left[Shift] { Left[Del]; Mode(0); }
    Right[Shift] { Right[Del]; Mode(0); }
    Home[Shift] { Home[Del]; Mode(0); }
    End[Shift] { End[Del]; Mode(0); }
    Left[Ctrl] { RevWord[Del]; Mode(0); }
    Right[Ctrl] { FwdWord[Del]; Mode(0); }
    Left[Shift|Ctrl] { RevWord[Del]; Mode(0); }
    Right[Shift|Ctrl] { FwdWordEnd[Del|Past]; Mode(0); }
    Left[Alt] { RevWord[Del|Unix]; Mode(0); }
    Right[Alt] { FwdWord[Del|Unix]; Mode(0); }
    Left[Shift|Alt] { RevWord[Del|Unix]; Mode(0); }
    Right[Shift|Alt] { FwdWordEnd[Del|Unix|Past]; Mode(0); }
    'w' { FwdWord[Del]; Mode(0); }
    'W' { FwdWord[Del|Unix]; Mode(0); }
    'e' { FwdWordEnd[Del]; Mode(0); }
    'E' { FwdWordEnd[Del|Unix]; Mode(0); }
    'g' { Mode(7); Mode(0); }
    'h' { Left[Del]; Mode(0); }
    'j' { Down[Del]; Mode(0); }
    'k' { Up[Del]; Mode(0); }
    'l' { Right[Del]; Mode(0); }
    'x' { Right[Del]; Mode(0); }
    'b' { RevWord[Del]; Mode(0); }
    'B' { RevWord[Del|Unix]; Mode(0); }
    '^' { Home[Del]; Mode(0); }
    '$' { End[Del]; Mode(0); }
    Any { Mode(3); }
    AnyFn { Mode(3); }
  }
  # '/' search fwd mode
  mode 9 {
    EndOfFile { AbortSrch[Redir]; }
    SigInt { AbortSrch[Redir]; }
    SigQuit { AbortSrch[Redir]; }
    SigSusp { AbortSrch[Redir]; }
    Any { Glyph; }
    AnyFn { Nop; }
    Erase { Left[Del]; }
    WErase { RevWord[Del|Unix]; }
    Kill { Home[Del]; }
    LNext { Glyph(, '^'); Left[Mv]; Push(1); }
    Enter { EnterSrchFwd; }
    Left { Left[Mv]; }
    Right { Right[Mv]; }
    Home { Home[Mv]; }
    End { End[Mv]; }
    Insert { InsToggle; }
    Delete { Right[Del]; }
    Left[Ctrl] { RevWord[Mv]; }
    Right[Ctrl] { FwdWord[Mv]; }
    Left[Alt] { RevWord[Mv|Unix]; }
    Right[Alt] { FwdWord[Mv|Unix]; }
    ^[ { AbortSrch; }
  }
  # '?' search rev mode
  mode 10 {
    EndOfFile { AbortSrch[Redir]; }
    SigInt { AbortSrch[Redir]; }
    SigQuit { AbortSrch[Redir]; }
    SigSusp { AbortSrch[Redir]; }
    Any { Glyph; }
    AnyFn { Nop; }
    Erase { Left[Del]; }
    WErase { RevWord[Del|Unix]; }
    Kill { Home[Del]; }
    LNext { Glyph(, '^'); Left[Mv]; Push(1); }
    Enter { EnterSrchRev; }
    Left { Left[Mv]; }
    Right { Right[Mv]; }
    Home { Home[Mv]; }
    End { End[Mv]; }
    Insert { InsToggle; }
    Delete { Right[Del]; }
    Left[Ctrl] { RevWord[Mv]; }
    Right[Ctrl] { FwdWord[Mv]; }
    Left[Alt] { RevWord[Mv|Unix]; }
    Right[Alt] { FwdWord[Mv|Unix]; }
    ^[ { AbortSrch; }
  }
}
