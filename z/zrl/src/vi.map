map vi {
  # default insert/edit mode
  mode 0 {
    EndOfFile { EndOfFile; }
    SigInt { SigInt; }
    SigQuit { SigQuit; }
    SigSusp { SigSusp; }
    Any { Glyph; }
    Erase { BackSpace; }
    WErase { RevWord[Del|Unix]; }
    Kill { Home[Del]; }
    LNext { Glyph(, '^'); Left[Mv]; Push(1); }
    Enter { Enter; }
    Up { Up[Mv]; }
    Down { Down[Mv]; }
    Left { Left[Mv]; }
    Right { Right[Mv]; }
    Home { Home[Mv]; }
    End { End[Mv]; }
    PgUp { Prev; }
    PgDn { Next; }
    Insert { InsToggle; }
    Delete { Right[Del|Copy]; }
    Up[Shift] { Up[Mv|Vis]; Push(2); }
    Down[Shift] { Down[Mv|Vis]; Push(2); }
    Left[Shift] { Left[Mv|Vis]; Push(2); }
    Right[Shift] { Right[Mv|Vis]; Push(2); }
    Home[Shift] { Home[Mv|Vis]; Push(2); }
    End[Shift] { End[Mv|Vis]; Push(2); }
    Left[Ctrl] { RevWord[Mv]; }
    Right[Ctrl] { FwdWord[Mv]; }
    Left[Shift|Ctrl] { RevWord[Mv|Vis]; Push(2); }
    Right[Shift|Ctrl] { FwdWordEnd[Mv|Vis|Past]; Push(2); }
    Left[Alt] { RevWord[Mv|Unix]; }
    Right[Alt] { FwdWord[Mv|Unix]; }
    Left[Shift|Alt] { RevWord[Mv|Vis|Unix]; Push(2); }
    Right[Shift|Alt] { FwdWordEnd[Mv|Vis|Unix|Past]; Push(2); }
    ^D { ListComplete; }
    ^I { Complete; }
    ^[ { EditRep; Left[Mv]; Mode(3); }
  }
  # literal next
  mode 1 {
    Any { OverGlyph; Pop; }
    AnyFn { Pop[Redir]; }
  }
  # highlight "visual" mode
  mode 2 {
    Any { ClrVis[Del]; Pop[Redir]; }
    AnyFn { ClrVis; Pop[Redir]; }
    Erase { Nop[Redir](, Delete); }
    Delete { ClrVis[Del]; Pop; }
    Up[Shift] { Up[Mv|Vis]; }
    Down[Shift] { Down[Mv|Vis]; }
    Left[Shift] { Left[Mv|Vis]; }
    Right[Shift] { Right[Mv|Vis]; }
    Home[Shift] { Home[Mv|Vis]; }
    End[Shift] { End[Mv|Vis]; }
    Left[Shift|Ctrl] { RevWord[Mv|Vis]; }
    Right[Shift|Ctrl] { FwdWordEnd[Mv|Vis|Past]; }
    Left[Shift|Alt] { RevWord[Mv|Vis|Unix]; }
    Right[Shift|Alt] { FwdWordEnd[Mv|Vis|Unix|Past]; }
    'd' { ClrVis[Del|Copy]; Pop; }
    'x' { Nop[Redir](, 'd'); }
    'c' { Nop[Redir](, 'd'); }
    's' { Nop[Redir](, 'd'); }
    'y' { ClrVis[Copy]; Pop; }
    'p' { ClrVis[Del]; Paste; Pop; }
    'P' { Nop[Redir](, 'p'); }
    '~' { CapVis; }
    'U' { UpperVis; }
    'u' { LowerVis; }
  }
  # command mode
  mode 3 command {
    EndOfFile { Mode[Redir](0); }
    SigInt { Mode[Redir](0); }
    SigQuit { Mode[Redir](0); }
    SigSusp { Mode[Redir](0); }
    Erase { Left[Mv]; }
    Enter { Mode(0); Enter; }
    Up { Up[Mv]; }
    Down { Down[Mv]; }
    Left { Left[Mv]; }
    Right { Right[Mv]; }
    Home { Home[Mv]; }
    End { End[Mv]; }
    PgUp { Prev; }
    PgDn { Next; }
    Insert { InsToggle; }
    Delete { Right[Del|Copy]; }
    Up[Shift] { Up[Mv|Vis]; Push(2); }
    Down[Shift] { Down[Mv|Vis]; Push(2); }
    Left[Shift] { Left[Mv|Vis]; Push(2); }
    Right[Shift] { Right[Mv|Vis]; Push(2); }
    Home[Shift] { Home[Mv|Vis]; Push(2); }
    End[Shift] { End[Mv|Vis]; Push(2); }
    Left[Ctrl] { RevWord[Mv]; }
    Right[Ctrl] { FwdWord[Mv]; }
    Left[Shift|Ctrl] { RevWord[Mv|Vis]; Push(2); }
    Right[Shift|Ctrl] { FwdWordEnd[Mv|Vis|Past]; Push(2); }
    Left[Alt] { RevWord[Mv|Unix]; }
    Right[Alt] { FwdWord[Mv|Unix]; }
    Left[Shift|Alt] { RevWord[Mv|Vis|Unix]; Push(2); }
    Right[Shift|Alt] { FwdWordEnd[Mv|Vis|Unix|Past]; Push(2); }
    '0' { DigitArg(0); }
    '1' { DigitArg(1); }
    '2' { DigitArg(2); }
    '3' { DigitArg(3); }
    '4' { DigitArg(4); }
    '5' { DigitArg(5); }
    '6' { DigitArg(6); }
    '7' { DigitArg(7); }
    '8' { DigitArg(8); }
    '9' { DigitArg(9); }
    'w' { FwdWord[Mv]; }
    'W' { FwdWord[Mv|Unix]; }
    'e' { FwdWordEnd[Mv]; }
    'E' { FwdWordEnd[Mv|Unix]; }
    'r' { EditArg; Mode(5); }
    'R' { EditArg; Mode(0); Over; }
    'y' { Mode(6); }
    'u' { Undo; }
    ^R { Redo; }
    'i' { EditArg; Insert; Mode(0); }
    'I' { EditArg; Insert; Mode(0); Home[Mv]; }
    'o' { Mode(0); End[Mv]; Home[Del]; }
    'O' { Nop[Redir](, 'o'); }
    'p' { Right[Mv]; Paste; Left[Mv]; }
    'P' { Paste; Left[Mv]; }
    'a' { EditArg; Mode(0); Right[Mv]; }
    'A' { EditArg; Mode(0); End[Mv]; }
    's' { Mode(0); Right[Del]; }
    'S' { Nop[Redir](, 'o'); }
    'd' { Mode(7); }
    'D' { End[Del|Copy]; }
    'g' { Mode(8); }
    'h' { Left[Mv]; }
    'j' { Down[Mv]; }
    'k' { Up[Mv]; }
    'l' { Right[Mv]; }
    'x' { Right[Del|Copy]; }
    'c' { Mode(10); }
    'C' { End[Del|Copy]; Mode(0); }
    'b' { RevWord[Mv]; }
    'B' { RevWord[Mv|Unix]; }
    'n' { FwdSearch; }
    'N' { RevSearch; }
    '/' { PromptSrch(11); }
    '?' { PromptSrch(12); }
    '^' { Home[Mv]; }
    '$' { End[Mv]; }
    '"' { Register; }
    '.' { Repeat; }
  }
  # 'r' single-character replace mode
  mode 5 {
    EndOfFile { Mode[Redir](0); }
    SigInt { Mode[Redir](0); }
    SigQuit { Mode[Redir](0); }
    SigSusp { Mode[Redir](0); }
    Any { OverGlyph; Mode(3); }
    AnyFn { Mode[Redir](3); }
  }
  # 'y' yank mode
  mode 6 command {
    EndOfFile { Mode[Redir](0); }
    SigInt { Mode[Redir](0); }
    SigQuit { Mode[Redir](0); }
    SigSusp { Mode[Redir](0); }
    Up { Up[Copy]; Mode(3); }
    Down { Down[Copy]; Mode(3); }
    Left { Left[Copy]; Mode(3); }
    Right { Right[Copy]; Mode(3); }
    Home { Home[Copy]; Mode(3); }
    End { End[Copy]; Mode(3); }
    Delete { Right[Copy]; Mode(3); }
    Up[Shift] { Up[Copy]; Mode(3); }
    Down[Shift] { Down[Copy]; Mode(3); }
    Left[Shift] { Left[Copy]; Mode(3); }
    Right[Shift] { Right[Copy]; Mode(3); }
    Home[Shift] { Home[Copy]; Mode(3); }
    End[Shift] { End[Copy]; Mode(3); }
    Left[Ctrl] { RevWord[Copy]; Mode(3); }
    Right[Ctrl] { FwdWord[Copy]; Mode(3); }
    Left[Shift|Ctrl] { RevWord[Copy]; Mode(3); }
    Right[Shift|Ctrl] { FwdWordEnd[Copy|Past]; Mode(3); }
    Left[Alt] { RevWord[Copy|Unix]; Mode(3); }
    Right[Alt] { FwdWord[Copy|Unix]; Mode(3); }
    Left[Shift|Alt] { RevWord[Copy|Unix]; Mode(3); }
    Right[Shift|Alt] { FwdWordEnd[Copy|Unix|Past]; Mode(3); }
    '0' { DigitArg(0); }
    '1' { DigitArg(1); }
    '2' { DigitArg(2); }
    '3' { DigitArg(3); }
    '4' { DigitArg(4); }
    '5' { DigitArg(5); }
    '6' { DigitArg(6); }
    '7' { DigitArg(7); }
    '8' { DigitArg(8); }
    '9' { DigitArg(9); }
    '0' { DigitArg(0); }
    'w' { FwdWord[Copy]; Mode(3); }
    'W' { FwdWord[Copy|Unix]; Mode(3); }
    'e' { FwdWordEnd[Copy]; Mode(3); }
    'E' { FwdWordEnd[Copy|Unix]; Mode(3); }
    'g' { Mode(9); Mode(3); }
    'h' { Left[Copy]; Mode(3); }
    'j' { Down[Copy]; Mode(3); }
    'k' { Up[Copy]; Mode(3); }
    'l' { Right[Copy]; Mode(3); }
    'x' { Right[Copy]; Mode(3); }
    'b' { RevWord[Copy]; Mode(3); }
    'B' { RevWord[Copy|Unix]; Mode(3); }
    '^' { Home[Copy]; Mode(3); }
    '$' { End[Copy]; Mode(3); }
    Any { Mode(3); }
    AnyFn { Mode(3); }
  }
  # 'd' delete mode
  mode 7 command {
    EndOfFile { Mode[Redir](0); }
    SigInt { Mode[Redir](0); }
    SigQuit { Mode[Redir](0); }
    SigSusp { Mode[Redir](0); }
    Up { Up[Del|Copy]; Mode(3); }
    Down { Down[Del|Copy]; Mode(3); }
    Left { Left[Del|Copy]; Mode(3); }
    Right { Right[Del|Copy]; Mode(3); }
    Home { Home[Del|Copy]; Mode(3); }
    End { End[Del|Copy]; Mode(3); }
    Delete { Right[Del|Copy]; Mode(3); }
    Up[Shift] { Up[Del|Copy]; Mode(3); }
    Down[Shift] { Down[Del|Copy]; Mode(3); }
    Left[Shift] { Left[Del|Copy]; Mode(3); }
    Right[Shift] { Right[Del|Copy]; Mode(3); }
    Home[Shift] { Home[Del|Copy]; Mode(3); }
    End[Shift] { End[Del|Copy]; Mode(3); }
    Left[Ctrl] { RevWord[Del|Copy]; Mode(3); }
    Right[Ctrl] { FwdWord[Del|Copy]; Mode(3); }
    Left[Shift|Ctrl] { RevWord[Del|Copy]; Mode(3); }
    Right[Shift|Ctrl] { FwdWordEnd[Del|Copy|Past]; Mode(3); }
    Left[Alt] { RevWord[Del|Copy|Unix]; Mode(3); }
    Right[Alt] { FwdWord[Del|Copy|Unix]; Mode(3); }
    Left[Shift|Alt] { RevWord[Del|Copy|Unix]; Mode(3); }
    Right[Shift|Alt] { FwdWordEnd[Del|Copy|Unix|Past]; Mode(3); }
    '0' { DigitArg(0); }
    '1' { DigitArg(1); }
    '2' { DigitArg(2); }
    '3' { DigitArg(3); }
    '4' { DigitArg(4); }
    '5' { DigitArg(5); }
    '6' { DigitArg(6); }
    '7' { DigitArg(7); }
    '8' { DigitArg(8); }
    '9' { DigitArg(9); }
    'w' { FwdWord[Del|Copy]; Mode(3); }
    'W' { FwdWord[Del|Copy|Unix]; Mode(3); }
    'e' { FwdWordEnd[Del|Copy]; Mode(3); }
    'E' { FwdWordEnd[Del|Copy|Unix]; Mode(3); }
    'g' { Mode(9); Mode(3); }
    'h' { Left[Del|Copy]; Mode(3); }
    'j' { Down[Del|Copy]; Mode(3); }
    'k' { Up[Del|Copy]; Mode(3); }
    'l' { Right[Del|Copy]; Mode(3); }
    'x' { Right[Del|Copy]; Mode(3); }
    'b' { RevWord[Del|Copy]; Mode(3); }
    'B' { RevWord[Del|Copy|Unix]; Mode(3); }
    '^' { Home[Del|Copy]; Mode(3); }
    '$' { End[Del|Copy]; Mode(3); }
    Any { Mode(3); }
    AnyFn { Mode(3); }
  }
  # 'g' go mode
  mode 8 command {
    EndOfFile { Mode[Redir](0); }
    SigInt { Mode[Redir](0); }
    SigQuit { Mode[Redir](0); }
    SigSusp { Mode[Redir](0); }
    'e' { Mode(3); RevWordEnd[Mv]; }
    'E' { Mode(3); RevWordEnd[Mv|Unix]; }
    Any { Mode(3); }
    AnyFn { Mode[Redir](3); }
  }
  # 'd' 'g' delete-go mode
  mode 9 command {
    EndOfFile { Mode[Redir](0); }
    SigInt { Mode[Redir](0); }
    SigQuit { Mode[Redir](0); }
    SigSusp { Mode[Redir](0); }
    'e' { Mode(3); RevWordEnd[Del]; }
    'E' { Mode(3); RevWordEnd[Del|Unix]; }
    Any { Mode(3); }
    AnyFn { Mode(3); }
  }
  # 'c' change mode
  mode 10 command {
    EndOfFile { Mode[Redir](0); }
    SigInt { Mode[Redir](0); }
    SigQuit { Mode[Redir](0); }
    SigSusp { Mode[Redir](0); }
    Up { Up[Del|Copy]; Mode(0); }
    Down { Down[Del|Copy]; Mode(0); }
    Left { Left[Del|Copy]; Mode(0); }
    Right { Right[Del|Copy]; Mode(0); }
    Home { Home[Del|Copy]; Mode(0); }
    End { End[Del|Copy]; Mode(0); }
    Delete { Right[Del]; Mode(0); }
    Up[Shift] { Up[Del|Copy]; Mode(0); }
    Down[Shift] { Down[Del|Copy]; Mode(0); }
    Left[Shift] { Left[Del|Copy]; Mode(0); }
    Right[Shift] { Right[Del|Copy]; Mode(0); }
    Home[Shift] { Home[Del|Copy]; Mode(0); }
    End[Shift] { End[Del|Copy]; Mode(0); }
    Left[Ctrl] { RevWord[Del|Copy]; Mode(0); }
    Right[Ctrl] { FwdWord[Del|Copy]; Mode(0); }
    Left[Shift|Ctrl] { RevWord[Del|Copy]; Mode(0); }
    Right[Shift|Ctrl] { FwdWordEnd[Del|Copy|Past]; Mode(0); }
    Left[Alt] { RevWord[Del|Copy|Unix]; Mode(0); }
    Right[Alt] { FwdWord[Del|Copy|Unix]; Mode(0); }
    Left[Shift|Alt] { RevWord[Del|Copy|Unix]; Mode(0); }
    Right[Shift|Alt] { FwdWordEnd[Del|Copy|Unix|Past]; Mode(0); }
    '0' { DigitArg(0); }
    '1' { DigitArg(1); }
    '2' { DigitArg(2); }
    '3' { DigitArg(3); }
    '4' { DigitArg(4); }
    '5' { DigitArg(5); }
    '6' { DigitArg(6); }
    '7' { DigitArg(7); }
    '8' { DigitArg(8); }
    '9' { DigitArg(9); }
    'w' { FwdWord[Del|Copy]; Mode(0); }
    'W' { FwdWord[Del|Copy|Unix]; Mode(0); }
    'e' { FwdWordEnd[Del|Copy]; Mode(0); }
    'E' { FwdWordEnd[Del|Copy|Unix]; Mode(0); }
    'g' { Mode(8); Mode(0); }
    'h' { Left[Del|Copy]; Mode(0); }
    'j' { Down[Del|Copy]; Mode(0); }
    'k' { Up[Del|Copy]; Mode(0); }
    'l' { Right[Del|Copy]; Mode(0); }
    'x' { Right[Del|Copy]; Mode(0); }
    'b' { RevWord[Del|Copy]; Mode(0); }
    'B' { RevWord[Del|Copy|Unix]; Mode(0); }
    '^' { Home[Del|Copy]; Mode(0); }
    '$' { End[Del|Copy]; Mode(0); }
    Any { Mode(3); }
    AnyFn { Mode(3); }
  }
  # '/' search fwd mode
  mode 11 {
    EndOfFile { AbortSrch[Redir]; }
    SigInt { AbortSrch[Redir]; }
    SigQuit { AbortSrch[Redir]; }
    SigSusp { AbortSrch[Redir]; }
    Any { Glyph; }
    AnyFn { Nop; }
    Erase { Left[Del]; }
    WErase { RevWord[Del|Unix]; }
    Kill { Home[Del]; }
    LNext { Glyph(, '^'); Left[Mv]; Push(1); }
    Enter { EnterSrchFwd; }
    Left { Left[Mv]; }
    Right { Right[Mv]; }
    Home { Home[Mv]; }
    End { End[Mv]; }
    Insert { InsToggle; }
    Delete { Right[Del]; }
    Left[Ctrl] { RevWord[Mv]; }
    Right[Ctrl] { FwdWord[Mv]; }
    Left[Alt] { RevWord[Mv|Unix]; }
    Right[Alt] { FwdWord[Mv|Unix]; }
    ^[ { AbortSrch; }
  }
  # '?' search rev mode
  mode 12 {
    EndOfFile { AbortSrch[Redir]; }
    SigInt { AbortSrch[Redir]; }
    SigQuit { AbortSrch[Redir]; }
    SigSusp { AbortSrch[Redir]; }
    Any { Glyph; }
    AnyFn { Nop; }
    Erase { Left[Del]; }
    WErase { RevWord[Del|Unix]; }
    Kill { Home[Del]; }
    LNext { Glyph(, '^'); Left[Mv]; Push(1); }
    Enter { EnterSrchRev; }
    Left { Left[Mv]; }
    Right { Right[Mv]; }
    Home { Home[Mv]; }
    End { End[Mv]; }
    Insert { InsToggle; }
    Delete { Right[Del]; }
    Left[Ctrl] { RevWord[Mv]; }
    Right[Ctrl] { FwdWord[Mv]; }
    Left[Alt] { RevWord[Mv|Unix]; }
    Right[Alt] { FwdWord[Mv|Unix]; }
    ^[ { AbortSrch; }
  }
}
